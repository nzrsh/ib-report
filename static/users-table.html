<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/styles/header.css" />
    <link rel="stylesheet" href="/static/styles/main.css" />
    <link rel="stylesheet" href="/static/styles/table.css" />
    <title>Пользователи</title>

    <style>
      /* --- Модалка --- */
      #modalBg {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      #modal {
        background: white;
        padding: 20px;
        border-radius: 8px;
        min-width: 320px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      }

      #modal input,
      #modal select {
        width: 100%;
        margin-top: 8px;
        padding: 8px;
      }

      #modal button {
        margin-top: 15px;
        padding: 10px 18px;
        cursor: pointer;
      }

      .btn-add {
        display: inline-block;
        margin-bottom: 15px;
        padding: 10px 16px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .btn-delete {
        padding: 6px 12px;
        background: #d9534f;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">IB report</div>

      <nav>
        <ul>
          <li><a href="/form">Создание отчёта</a></li>
          <li><a href="/event-table">Список событий</a></li>
          <li><a href="/incident-table/none">Список инцидентов</a></li>
          <li id="userslist">
            <a href="/users-table" class="active">Пользователи</a>
          </li>
          <li><a href="/login">Выход</a></li>
        </ul>
      </nav>
    </header>

    <h1>Список пользователей</h1>

    <button class="btn-add" id="openModalBtn">Добавить пользователя</button>

    <table border="1" cellpadding="5" cellspacing="0" id="usersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Логин</th>
          <th>Роль</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="eventsBody"></tbody>
    </table>

    <div id="pagination" style="margin-top: 20px">
      <button id="prevBtn">Предыдущая</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">Следующая</button>
    </div>

    <!-- ===== Модальное окно добавления пользователя ===== -->
    <div id="modalBg">
      <div id="modal">
        <h2>Добавить пользователя</h2>

        <label>Логин:</label>
        <input type="text" id="loginInput" />

        <label>Имя (необязательно):</label>
        <input type="text" id="nameInput" />

        <label>Пароль:</label>
        <input type="password" id="passwordInput" />

        <label>Роль:</label>
        <select id="roleInput">
          <option value="admin">admin</option>
          <option value="user">user</option>
        </select>

        <button id="addUserBtn">Создать</button>
        <button id="closeModalBtn">Отмена</button>
      </div>
    </div>

    <script>
      // ---- Открытие/закрытие модалки ----
      const modalBg = document.getElementById("modalBg");
      document.getElementById("openModalBtn").onclick = () =>
        (modalBg.style.display = "flex");

      document.getElementById("closeModalBtn").onclick = () =>
        (modalBg.style.display = "none");

      // ---- Создание пользователя ----
      document.getElementById("addUserBtn").onclick = async () => {
        const login = document.getElementById("loginInput").value;
        const name = document.getElementById("nameInput").value;
        const password = document.getElementById("passwordInput").value;
        const role = document.getElementById("roleInput").value;

        const resp = await fetch("/api/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ login, name, password, role }),
        });

        if (resp.ok) {
          alert("Пользователь создан!");
          location.reload();
        } else {
          alert("Ошибка при создании.");
        }
      };

      // ---- Удаление пользователя ----
      async function deleteUser(id) {
        if (!confirm("Удалить пользователя?")) return;

        const resp = await fetch(`/api/users/${id}`, { method: "DELETE" });
        if (resp.ok) location.reload();
        else alert("Ошибка удаления");
      }
    </script>

    <script src="/static/scripts/users-table.js"></script>
    <script src="/static/scripts/hidden-content.js"></script>
  </body>
</html>
